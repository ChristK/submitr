---
title: "Creating a `{learnr}` tutorial with event logging via `{submitr}`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using submitr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
library(submitr)
```

NOTES:

- Install `googlesheets4` from GitHub, not CRAN


The `{learnr}` package provides facilities for writing interactive R tutorials. `{submitr}` extends `{learnr}` so that tutorials can log student interaction. This can be useful for monitoring the use of a tutorial, looking for patterns in student answers, or assigning a grade to students.

This vignette is oriented toward authors of `{learnr}` tutorials.

## A minimal example

The file `"minimal-example.Rmd"` is a short example of a `{learnr}` tutorial that illustrates the essentials of writing a tutorial using `{submitr}`. 

You may want to start by running the tutorial from the command line:

```{r eval=FALSE}
learnr::run_tutorial("minimal", package = "submitr")
```

Each page of the tutorial is laid out in the usual manner. By default, `{learnr}` puts a table of contents in a left column. `{submitr}` adds login ID and Password fields at the top of the page. For the minimal example the ID/Password pair "Anne/demo" can be used. An event will be logged whenever you perform a "submit" or "run" action or watch the video.

```{r echo=FALSE, fig.cap="Snapshot of the minimal tutorial at start-up"}
knitr::include_graphics("images/minimal-first-page.png")
```

You can explore the document and its action better if you create your own copy to run directly. To do this, copy the `.Rmd` source file to a new file that you can edit. To illustrate, we'll call the new file `minimal.Rmd`. Make the copy with this command:

```{r eval=FALSE}
file.copy(
  system.file("tutorials/Minimal/minimal.Rmd", package = "submitr"),
  "./minimal.Rmd")
```

Let's consider the various components of `minimal.Rmd`.

### The YAML header

As with all `{learnr}` tutorials, the source document starts with a YAML header.

```{yaml}
---
title: "A Minimal `{submitr}` Example"
output: learnr::tutorial
runtime: shiny_prerendered
tutorial:
  id: "minimal-example"
  version: 0.5
---
```

Note the `tutorial:` section and its fields `id:` and `version:`. You will want to set the `id:` to something unique for each document so that the event logging system can report which document a submission comes from. 

### The `setup` chunk

````
`r ""````{r setup, include=FALSE}
library(learnr)
library(submitr)
knitr::opts_chunk$set(echo = FALSE)
learnr::tutorial_options(
  exercise.timelimit = 60, 
  exercise.checker = submitr::null_code_checker)
`r ""````
````

You can put any additional content you need in the `setup` chunk, but make sure to load both the `{learnr}` and `{submitr}` packages.

The `learnr::tutorial_options()` function is being used to set the exercise checker to be used when processing user code submissions. It's not mandatory to do this. The `{gradethis}` package provides facilities for such code checking. The `submitr::null_code_checker` is just a placeholder that displays a reminder that no genuine checking is being done.

### Login controls

Each document must contain the login controls. These are `{shiny}` components predefined by the `submitr::login_controls()` function.

````
`r ""````{r}
submitr::login_controls()
`r ""````
````

By putting the login controls before the first section heading, you ensure that they will be visible on *each* page of the tutorial. This can be helpful to the user, giving a constant reminder of whether she is logged in.

### Setting logging parameters

The final `{submitr}`-specific chunk sets the location of the event log,
passwords for user authentication, and so on. 

````
`r ""````{r context="server", echo = FALSE}
options(tutorial.storage = "none")
vfun <- basket::check_valid
storage_actions <-
  in_google_sheets(
    "1w3fEld2rZlR_6FuzvkA-viOLBA5JdqD3xHl-LuLX3-Y",
    "statprep.annie@gmail.com",
    vfun)
submitr::shiny_logic(input, output, session, vfun,
                     storage_actions)
`r ""````
````

Let's go through it line by line. First, note the chunk parameter `context="server"`.  *This is essential for the login controls to be effective.* 

1. `options(tutorial.storage = "none")`. By default, `{learnr}` bookmarks previous user entries so that they appear in the document on startup. This line turns off that feature so that the previous user ID and password are not filled in at startup. [At some point in the future it would be helpful to modify `{learnr}` to disable the bookmarking automatically for login controls and allow the document author to set the bookmarking policy as desired for the other components of the document.]

2. `vfun <- basket::check_valid`. All of the handling of credentials and authorization (if needed) to write to the logging database is handled by a single, user-provided function accessed *via* the name `vfun`. This will be described in detail in another section. Note that the right-hand side of the assignment here does not include function-evaluation parentheses; we're giving an alias (`vfun`) to the function itself rather than evaluating the function. 

3. `storage_actions` is the name holding information about the place where logged events will be stored. We'll defer details to a later section. In this example, the events are stored locally in a file named `"submissions.csv"`.

4. `submitr::shiny_logic()` implements the logic needed to connect the login controls to the rest of the logging system.


## Writing to Google Sheets
```
  # gs4_recorder(
  #   "1w3fEld2rZlR_6FuzvkA-viOLBA5JdqD3xHl-LuLX3-Y",
  #   "statprep.annie@gmail.com",
  #   vfun)
```

## Setting up a class

I'll take the point of view that an instructor plans to use multiple `{learnr}` tutorials over the span of a semester, but the same procedures would apply even to a single document. These instructions would be followed once, at the start of the semester. 

First, create a CSV file to hold student ID's and passwords. The structure is very simple, e.g.

id       |   password
---------|------------
George   | cherry-tree
Martha   | vernon
Madison  | dolly

(An example is available in the data frame `example_credentials` provide with `{submittr}`. [MAKE SURE THIS IS UP TO DATE.])

Notice that passwords are being stored in plain text. (This should be improved: See <https://github.com/dtkaplan/submitr/issues/1>.) As long as this is the case, don't use passwords that are intended to be secure and are used on other systems. A student ID number could make a good password, easily memorable to the student and not requiring the instructor's intervention.

Second, decide how you are going to deploy the tutorial. `{Submitr}` is designed to work with three modes of deployment:

1. Shinyapps.io or similar service. What's distinctive about these services is that it's not possible to store log files persistently on the server itself and that the instructor cannot directly access the Rmd and related files that are stored on the service.
2. Another kind of Shiny server where files can be stored persistently and directly accessed by the instructor. Shiny Server is an example of such a server.
3. Directly provided to students in source form (Rmd) to run on the student's own computer or a user-account-based web service such as `rstudio.cloud`. This includes distributing the tutorials as a package.

Tutorials do not need to be written all at the same time. You may deploy tutorials for the same students in different ways, but I anticipate most instructors would follow the simplest route and use just one mode of deployment.

## Storing the student activity log

`{Submitr}` currently implements two modes for storing the log of activities.

1. Locally, where the tutorial is deployed. This **cannot** be used on a Shinyapps.io-type server.
2. As a Google spreadsheet. This can be used for all of the modes of deployment. Note that authentication information for the Google account used for storage will be in the source tree for the tutorial, hence accessible to whomever can access the source. If you are distributing the source files of a tutorial to students, they will therefore have access to the authentication information. On the other hand, if you are distributing source files to students, you should be in a situation where local file storage (1) can be used.

## Storing user IDs and passwords

Storage of user IDs and passwords is done completely separately from the logging of tutorial events. 

The easiest approach to manage is to copy the id/password CSV file mentioned earlier into a Google spreadsheet. If the sheet is set to be readable by anyone with the link, you will not need authentication information for the tutorial to access the sheet. If the tutorial is being deployed on an server of any sort, the address of the sheet will not be accessible to students and the method is reasonably secure.

Alternatively, you can simply store the id/password CSV file in the same folder as the Rmd for the app itself, or even create a corresponding data frame in the tutorial Rmd file itself. This approach precludes using the same id/password file for multiple tutorials. 

If students will be running tutorials on their own machines (or on individual accounts on `rstudio.cloud` or the like), you may want to have all students use the same ID/password combination (e.g, `stats110::fall2020`). Each student's individual user name on the RStudio system will be included in the submission, so you can use this information, rather than the ID/password combination, to identify which submissions belong to which students.

## Structure of a tutorial with `{submitr}`

Start with a working tutorial document. Confirm that it works and can be deployed successfully.

Now you will make some small changes to the Rmd source file for the tutorial.

**In the YAML header**

Add three lines identifying the tutorial. This information allows you easily to determine which submissions come from which tutorial. The lines will look like this, with a unique ID assigned by the author for each distinct tutorial:

    tutorial:
      id: "stats-101-assignment-3"
      version: 1.2
    
**At the start of the document**

Add a section at the start of the document that authorizes the tutorial to access the user-credential information and the log storage. For Google sheets storage, the section will 
look like this.

````
`` `{r __login__, context = "setup"}
instructor_key <- "something secret"
credentials <- 
  "1h_G3M-HTVfrC8lqHS8aKn_jVFg2_Rnnbtk5erpWX54o"
storage_actions <- in_google_sheets(
  "1D9kzkgUEGRvv2Q7q2n8ca9gcZk1_aglodbGJ3rLCYjI",
  email = "statprep.annie@gmail.com")
`` `
````

The long character strings are Google Sheets "keys," from which the URL of the credentials file and the submission storage, the means used by the `{googlesheets4}` package to read and write Google sheets.

After the `__login__` chunk, add a new chunk which will always be *exactly* as follows:

````
`` `{r child=system.file("submitr_login_script.Rmd", package = "submitr")}
```
````

To emphasize: The "child=" chunk must go after the chunk defining credentials, passwords, and the instructor key


If you are using local file storage, replace the `storage_actions` assignment with something like this:

```r
storage_actions <- in_local_file("submissions.csv")
```
You can choose a file name other than `"submissions.csv"` and even use different files for different tutorials.

If you want to use a local file to store the student credentials, do so by replacing the `credentials` line in the above with something like this:

```r
credentials <- "my_students_credentials.csv"
```

The CSV credentials file, if one is used, needs to be in the same directory as the tutorial's source Rmd file.

## Downloading the submissions

As students use the tutorials, their actions will be recorded in the submissions file or Google Sheet. If the tutorials are deployed via server, the instructor can access these directly, either by going to the Google Sheet or logging into the server to harvest the file.

`{Submitr}` provides an additional means to download the submissions directly from the tutorial. This is helpful if there will be multiple graders or, when there are multiple tutorials, simply to help an instructor keep track of which submissions file is which.

Downloading is done by a link under the login boxes. By default, the link is not accessible. To access the link, give the user ID "instructor" in the login box and the `instructor_key` (set earlier in the document) as the password. 

I imagine the main use for this will be for instructors and graders, to give them access to the stored submissions for each tutorial. However, by giving students the instructor key (perhaps something obvious like `download`), students can access the submissions as well. Allowing this would make sense if students are running the tutorial on their own computers or using `rstudio.cloud` or a similar server. In this scenario, students would hand in their submissions file by, e.g., uploading it to a course support system such as Blackboard or Moodle. 

## Creating and accessing a Google Sheets file

If you are using local file storage for the submissions, there is no setup required. This section is about using Google Sheets to store submissions.

The first step is to login to your Google Sheets account and create a blank sheet. I encourage you to create a unique sheet for each tutorial (and even from semester to semester), but you can equally well use a single sheet for all submissions. (The objective of using multiple sheets is to keep each one from getting so large that it's unwieldy.)

A good way to create the Google Sheet is to upload a CSV file with the column names already initialized. Such a file is available on your system at the path produced by

`system.file("submissions_header.csv", package = "submitr")`

Once created, copy the "key" for the file. It's available from the URL for the sheet and will resemble the examples shown above for the `credentials <-` amd `in_google_sheets()`.

Next, you need to create the authentication token to allow your tutorial to write to the submissions store sheet. You can do this from the R console.

1. Use `setwd()` in R to navigate to the folder with your tutorial's Rmd file. (Apologies to Jenny Bryan who emphasizes that this is in general a bad practice and promises to set on fire the computer of anyone who does it. Have a fire extinguisher available just in case!)

2. Give the following commands in the R console

```r
options(gargle_oauth_cache = ".secrets")
googledrive::drive_auth()
```

In response, Google will ask for permissions .... Give them for the Google account in which you created the submissions storage sheet. 

3. Give the additional R command
```r
googlesheets4::gs4_auth(
  token = googledrive::drive_token())
```

This process will create a folder named `.secrets` in the current R working directory (which will be where your tutorial's Rmd lives). That folder will have a file whose name ends in the google email address for the account in which the submissions storage sheet was created. 

You will want to prevent student access to the `.secrets` folder. Deploying your app to a server will not give such access. But other things you might do can, for example using a GitHub repo without "ignoring" the folder.

4. (Optionally) Test that things are working. In the same session in which you give the commands in step (2), give the following command:

`Testing <- sheets_read("1D9kzkg` ... *or, rather, the key for your own Google sheet.*`)`

## Storing credentials in Google Sheets

If you are using a Google account to provide the storage for submissions, you will have, following the steps in the previous section, provided access to any other sheet, including the one you create for holding credentials.

But you might prefer to enable the credentials to be read from within the tutorial *without* needing a `.secrets` folder. You can accomplish this by using Google Sheets to "share" the file in read mode to anyone with the key. The key itself will be visible in the source Rmd for your tutorial, but not visible to the users of your tutorial from a server.^[This option of using "share" to provide access to the credentials sheet works because there is no need for a tutorial to *write* to a credentials file. For the submissions storage sheet, writing is essential to the task. Writing to a Google Sheet from within R requires authentication in the form of a token.]

If you will be distributing your tutorials in source form, e.g. as part of a package, it's generally appropriate *not* to use Google Sheets. Instead, include the CSV credentials file directly in the *same folder* as your Rmd source.

## Interpreting a submissions log

*At some point* I will write software to generate reports from a log, then add a shiny app into this package for that purpose.
